version: '3.3'

services:
  bitcoind:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bitcoin-node
    restart: unless-stopped
    ports:
      # P2P network port
      - "8333:8333"
      # RPC port (exposed to all interfaces for external access)
      # ⚠️ 보안: rpcallowip로 접근 IP를 제한하세요
      - "8332:8332"
    volumes:
      # Persistent storage for blockchain data
      # IMPORTANT: Make sure /mnt/cryptocur-data/bitcoin directory exists and has proper permissions
      # Run: sudo mkdir -p /mnt/cryptocur-data/bitcoin
      # Run: BITCOIN_UID=$(docker run --rm docker_bitcoind id -u bitcoin) && sudo chown -R $BITCOIN_UID:$BITCOIN_UID /mnt/cryptocur-data/bitcoin
      - /mnt/cryptocur-data/bitcoin:/home/bitcoin/.bitcoin
      # Configuration file mount (optional, only if file exists)
      - ./bitcoin.conf:/home/bitcoin/.bitcoin/bitcoin.conf:ro
    environment:
      # Environment variables (used if config file is not available)
      BITCOIN_RPC_USER: ${BITCOIN_RPC_USER:-bitcoin}
      BITCOIN_RPC_PASSWORD: ${BITCOIN_RPC_PASSWORD:-changeme}
    command:
      # Execute bitcoind with options
      - bitcoind
      # Basic options
      - -printtoconsole
      - -txindex=1
      - -dbcache=4500
      - -server=1
      # Reindex chainstate to recover from LevelDB corruption
      # Remove this option after reindexing is complete
      - -reindex-chainstate
      # Config file is automatically used if bitcoin.conf is mounted
      # If config file is not available, use environment variables below
      - -rpcuser=${BITCOIN_RPC_USER:-bitcoin}
      - -rpcpassword=${BITCOIN_RPC_PASSWORD:-changeme}
      - -rpcbind=0.0.0.0
      - -rpcallowip=0.0.0.0
      - -rpcallowip=172.21.0.0/16  # Docker 네트워크 (docker_bitcoin-network)
    healthcheck:
      # Use cookie file (more secure) - bitcoind automatically creates .cookie when RPC is enabled
      # Cookie file is created at /home/bitcoin/.bitcoin/.cookie
      # Alternative: Use environment variables via shell script: /bin/bash -c "bitcoin-cli -rpcuser=${BITCOIN_RPC_USER} -rpcpassword=${BITCOIN_RPC_PASSWORD} getblockchaininfo"
      test: ["CMD-SHELL", "bitcoin-cli -rpccookiefile=/home/bitcoin/.bitcoin/.cookie getblockchaininfo 2>/dev/null || bitcoin-cli -rpcuser=${BITCOIN_RPC_USER} -rpcpassword=${BITCOIN_RPC_PASSWORD} getblockchaininfo || exit 1"]
      interval: 60s
      timeout: 10s
      start_period: 300s
      retries: 3
    networks:
      - bitcoin-network
    # Resource limits (optional)
    # Note: 'deploy' is only supported in Docker Swarm mode
    # For docker-compose, use 'docker update' command to set resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4'
    #       memory: 8G
    #     reservations:
    #       cpus: '2'
    #       memory: 4G

# volumes:
#   bitcoin-data:
#     # Using bind mount to /mnt/cryptocur-data/bitcoin
#     # Data will be stored in /mnt/cryptocur-data/bitcoin on the host
#     # Make sure the directory exists and has proper permissions before starting

networks:
  bitcoin-network:
    driver: bridge

