version: '3.3'

services:
  bitcoind:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bitcoin-node
    restart: unless-stopped
    ports:
      # P2P network port
      - "8333:8333"
      # RPC port (exposed to localhost only)
      - "127.0.0.1:8332:8332"
    volumes:
      # Persistent storage for blockchain data
      - bitcoin-data:/home/bitcoin/.bitcoin
      # Configuration file mount (optional, only if file exists)
      - ./bitcoin.conf:/home/bitcoin/.bitcoin/bitcoin.conf:ro
    environment:
      # Environment variables (used if config file is not available)
      BITCOIN_RPC_USER: ${BITCOIN_RPC_USER:-bitcoin}
      BITCOIN_RPC_PASSWORD: ${BITCOIN_RPC_PASSWORD:-changeme}
    command:
      # Basic options
      - -printtoconsole
      - -txindex=1
      - -dbcache=4500
      - -server=1
      # Config file is automatically used if bitcoin.conf is mounted
      # If config file is not available, use environment variables below
      - -rpcuser=${BITCOIN_RPC_USER:-bitcoin}
      - -rpcpassword=${BITCOIN_RPC_PASSWORD:-changeme}
      - -rpcbind=0.0.0.0
      - -rpcallowip=127.0.0.1
    networks:
      - bitcoin-network
    # Resource limits (optional)
    # Note: 'deploy' is only supported in Docker Swarm mode
    # For docker-compose, use 'docker update' command to set resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4'
    #       memory: 8G
    #     reservations:
    #       cpus: '2'
    #       memory: 4G

volumes:
  bitcoin-data:
    # Using named volume (automatically managed by Docker)
    # Data will be stored in Docker's volume directory
    # To use a specific host path, uncomment the driver_opts below and create the directory first
    driver: local
    # For bind mount to specific directory, uncomment below and create ./data directory:
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: ${BITCOIN_DATA_PATH:-./data}

networks:
  bitcoin-network:
    driver: bridge

