version: '3.3'

services:
  ethereum:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GIT_VERSION: ${GIT_VERSION:-latest}
    container_name: ethereum-node
    restart: unless-stopped
    ports:
      # Geth P2P network port (TCP)
      - "30303:30303/tcp"
      # Geth P2P network port (UDP)
      - "30303:30303/udp"
      # Geth Engine API port (internal, for Prysm communication)
      - "127.0.0.1:3001:3001"
      # Geth HTTP-RPC port (exposed to localhost only)
      - "127.0.0.1:3002:3002"
      # Prysm P2P network port (TCP)
      - "13000:13000/tcp"
      # Prysm P2P network port (UDP)
      - "13000:13000/udp"
      # Prysm gRPC port (exposed to localhost only)
      - "127.0.0.1:4000:4000"
      # Prysm HTTP-RPC port (exposed to localhost only)
      - "127.0.0.1:3500:3500"
    volumes:
      # Persistent storage for blockchain data
      # IMPORTANT: Make sure /mnt/cryptocur-data/ethereum directory exists and has proper permissions
      # Run: sudo mkdir -p /mnt/cryptocur-data/ethereum
      # Run: sudo chown -R 1000:1000 /mnt/cryptocur-data/ethereum
      - /mnt/cryptocur-data/ethereum:/var/lib/coindata
    environment:
      # P2P port for Geth (required)
      P2PPORT: ${P2PPORT:-30303}
      # Network mode: mainnet (default), goerli, sepolia
      MODE: ${MODE:-mainnet}
      # Maximum peer connections
      MAXPEERS: ${MAXPEERS:-25}
    networks:
      - ethereum-network
    # Resource limits (optional)
    # Note: 'deploy' is only supported in Docker Swarm mode
    # For docker-compose, use 'docker update' command to set resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '8'
    #       memory: 16G
    #     reservations:
    #       cpus: '4'
    #       memory: 8G

networks:
  ethereum-network:
    driver: bridge
