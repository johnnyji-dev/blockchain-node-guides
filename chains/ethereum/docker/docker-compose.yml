version: '3.3'

services:
  ethereum:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GIT_VERSION: ${GIT_VERSION:-latest}
    container_name: ethereum-node
    restart: unless-stopped
    ports:
      # Geth P2P network port (TCP) - Solana(3000, 8000-8025)와 충돌 방지
      - "30313:30313/tcp"
      # Geth P2P network port (UDP)
      - "30313:30313/udp"
      # Geth Engine API port (internal, for Prysm communication)
      - "127.0.0.1:3011:3011"
      # Geth HTTP-RPC port (exposed to localhost only)
      - "127.0.0.1:3012:3012"
      # Prysm P2P network port (TCP)
      - "13010:13010/tcp"
      # Prysm P2P network port (UDP)
      - "13010:13010/udp"
      # Prysm gRPC port (exposed to localhost only)
      - "127.0.0.1:4010:4010"
      # Prysm HTTP-RPC port (exposed to localhost only)
      - "127.0.0.1:3510:3510"
    volumes:
      # Persistent storage for blockchain data
      # IMPORTANT: Make sure /mnt/cryptocur-data/ethereum directory exists and has proper permissions
      # Run: sudo mkdir -p /mnt/cryptocur-data/ethereum
      # Run: sudo chown -R 1000:1000 /mnt/cryptocur-data/ethereum
      - /mnt/cryptocur-data/ethereum:/var/lib/coindata
    environment:
      # P2P port for Geth (required) - Solana와 충돌 방지를 위해 30313 사용
      P2PPORT: ${P2PPORT:-30313}
      # Network mode: mainnet (default), goerli, sepolia
      MODE: ${MODE:-mainnet}
      # Maximum peer connections
      MAXPEERS: ${MAXPEERS:-25}
    networks:
      - ethereum-network
    # Resource limits (optional)
    # Note: 'deploy' is only supported in Docker Swarm mode
    # For docker-compose, use 'docker update' command to set resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '8'
    #       memory: 16G
    #     reservations:
    #       cpus: '4'
    #       memory: 8G

networks:
  ethereum-network:
    driver: bridge
