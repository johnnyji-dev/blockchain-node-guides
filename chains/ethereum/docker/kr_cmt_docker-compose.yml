# ============================================================================
# Docker Compose File Version
# ============================================================================
# version: Docker Compose 파일 형식 버전을 지정합니다.
# '3.3'은 Docker Compose 버전 3.3 형식을 사용합니다.
# 이 버전은 Docker Engine 17.06.0 이상에서 지원됩니다.
# 최신 기능과 호환성을 위해 적절한 버전을 선택하는 것이 중요합니다.
version: '3.3'

# ============================================================================
# Services Definition
# ============================================================================
# services: 이 섹션에서 실행할 컨테이너 서비스들을 정의합니다.
# 각 서비스는 독립적인 컨테이너로 실행되며, 서로 통신할 수 있습니다.
services:
  # ethereum: Ethereum 통합 노드 서비스 (Geth + Prysm)
  # 이 이름은 docker-compose 명령어에서 서비스를 참조할 때 사용됩니다.
  # 예: docker-compose logs ethereum
  ethereum:
    # ========================================================================
    # Build Configuration
    # ========================================================================
    # build: Docker 이미지를 빌드하는 방법을 지정합니다.
    # 이미지를 미리 빌드하지 않고 docker-compose up 시 자동으로 빌드합니다.
    build:
      # context: Docker 빌드 컨텍스트 경로
      # '.'는 현재 디렉토리(docker-compose.yml이 있는 위치)를 의미합니다.
      # Dockerfile과 필요한 파일들이 이 경로에 있어야 합니다.
      context: .
      # dockerfile: 사용할 Dockerfile 이름
      # 기본값은 'Dockerfile'이지만, 다른 이름을 사용할 수 있습니다.
      dockerfile: Dockerfile
      # args: 빌드 시 전달할 인수
      args:
        # GIT_VERSION: Git 버전 정보 (선택사항)
        GIT_VERSION: ${GIT_VERSION:-latest}

    # ========================================================================
    # Container Configuration
    # ========================================================================
    # container_name: 컨테이너에 부여할 이름
    # 지정하지 않으면 '프로젝트명-서비스명-번호' 형식으로 자동 생성됩니다.
    # 고정된 이름을 사용하면 컨테이너를 쉽게 참조할 수 있습니다.
    # 예: docker logs ethereum-node
    container_name: ethereum-node

    # restart: 컨테이너 재시작 정책
    # unless-stopped: 컨테이너가 명시적으로 중지되지 않는 한 자동으로 재시작합니다.
    #   - Docker 데몬이 시작될 때 자동으로 컨테이너를 시작합니다.
    #   - 컨테이너가 크래시되면 자동으로 재시작합니다.
    #   - docker-compose stop으로 중지한 경우에는 재시작하지 않습니다.
    # 다른 옵션: no, always, on-failure
    restart: unless-stopped

    # ========================================================================
    # Port Mapping
    # ========================================================================
    # ports: 호스트와 컨테이너 간의 포트 매핑을 정의합니다.
    # 형식: "호스트포트:컨테이너포트" 또는 "호스트IP:호스트포트:컨테이너포트"
    ports:
      # Geth P2P 네트워크 포트 (TCP)
      # "30303:30303/tcp": 호스트의 30303 포트를 컨테이너의 30303 포트에 매핑 (TCP)
      #   - 호스트의 모든 네트워크 인터페이스(0.0.0.0)에서 접근 가능
      #   - 다른 Ethereum 노드들이 이 포트로 연결할 수 있습니다.
      #   - 방화벽에서 이 포트를 열어야 인바운드 연결을 받을 수 있습니다.
      - "30303:30303/tcp"
      # Geth P2P 네트워크 포트 (UDP)
      # "30303:30303/udp": 호스트의 30303 포트를 컨테이너의 30303 포트에 매핑 (UDP)
      #   - P2P 네트워크 통신에 UDP도 사용됩니다.
      - "30303:30303/udp"
      # Geth Engine API 포트 (로컬호스트만 노출)
      # "127.0.0.1:3001:3001": 호스트의 localhost(127.0.0.1) 3001 포트만 컨테이너의 3001 포트에 매핑
      #   - Engine API는 Consensus Layer(Prysm)와 Execution Layer(Geth) 간 통신에 사용됩니다.
      #   - JWT 인증을 사용하여 보안이 강화됩니다.
      #   - localhost로 제한하여 보안을 강화합니다.
      - "127.0.0.1:3001:3001"
      # Geth HTTP-RPC 포트 (로컬호스트만 노출)
      # "127.0.0.1:3002:3002": 호스트의 localhost(127.0.0.1) 3002 포트만 컨테이너의 3002 포트에 매핑
      #   - JSON-RPC API를 HTTP를 통해 제공합니다.
      #   - localhost로 제한하여 보안을 강화합니다.
      - "127.0.0.1:3002:3002"
      # Prysm P2P 네트워크 포트 (TCP)
      # "13000:13000/tcp": 호스트의 13000 포트를 컨테이너의 13000 포트에 매핑 (TCP)
      #   - 다른 Prysm 노드들이 이 포트로 연결할 수 있습니다.
      - "13000:13000/tcp"
      # Prysm P2P 네트워크 포트 (UDP)
      # "13000:13000/udp": 호스트의 13000 포트를 컨테이너의 13000 포트에 매핑 (UDP)
      - "13000:13000/udp"
      # Prysm gRPC 포트 (로컬호스트만 노출)
      # "127.0.0.1:4000:4000": 호스트의 localhost(127.0.0.1) 4000 포트만 컨테이너의 4000 포트에 매핑
      #   - gRPC API를 제공합니다.
      - "127.0.0.1:4000:4000"
      # Prysm HTTP-RPC 포트 (로컬호스트만 노출)
      # "127.0.0.1:3500:3500": 호스트의 localhost(127.0.0.1) 3500 포트만 컨테이너의 3500 포트에 매핑
      #   - Beacon API를 HTTP를 통해 제공합니다.
      - "127.0.0.1:3500:3500"

    # ========================================================================
    # Volume Mounts
    # ========================================================================
    # volumes: 호스트와 컨테이너 간의 디렉토리/파일 마운트를 정의합니다.
    # 컨테이너가 삭제되어도 데이터가 유지되도록 합니다.
    volumes:
      # 블록체인 데이터 영구 저장 (바인드 마운트)
      # /mnt/cryptocur-data/ethereum:/var/lib/coindata: 호스트의 특정 경로를 컨테이너 경로에 직접 마운트
      #   - /mnt/cryptocur-data/ethereum: 호스트의 절대 경로 (블록체인 데이터가 저장될 위치)
      #   - /var/lib/coindata: 컨테이너 내부의 데이터 디렉토리 (Geth와 Prysm 데이터 모두 저장)
      #   - 이 경로에는 블록체인 데이터(수백 GB), 지갑 파일, 설정 파일 등이 저장됩니다.
      #   - 컨테이너를 재생성해도 데이터가 유지됩니다.
      # 중요: 디렉토리가 존재하고 적절한 권한이 설정되어 있어야 합니다.
      #   실행 전에 다음 명령어를 실행하세요:
      #   sudo mkdir -p /mnt/cryptocur-data/ethereum
      #   sudo chown -R 1000:1000 /mnt/cryptocur-data/ethereum
      - /mnt/cryptocur-data/ethereum:/var/lib/coindata

    # ========================================================================
    # Environment Variables
    # ========================================================================
    # environment: 컨테이너 내부에서 사용할 환경 변수를 설정합니다.
    # ${VARIABLE:-default}: 환경 변수가 설정되지 않으면 기본값을 사용합니다.
    # 호스트의 환경 변수나 .env 파일에서 값을 가져올 수 있습니다.
    environment:
      # P2P 포트 설정 (필수)
      # P2PPORT: Geth P2P 네트워크 포트
      # ${P2PPORT:-30303}: 환경 변수가 없으면 '30303'을 기본값으로 사용
      # .env 파일이나 호스트 환경 변수로 설정할 수 있습니다.
      P2PPORT: ${P2PPORT:-30303}
      # 네트워크 모드 설정
      # MODE: 사용할 Ethereum 네트워크
      # ${MODE:-mainnet}: 환경 변수가 없으면 'mainnet'을 기본값으로 사용
      # 가능한 값: mainnet, goerli, sepolia
      # .env 파일이나 호스트 환경 변수로 설정할 수 있습니다.
      MODE: ${MODE:-mainnet}
      # 최대 피어 연결 수 설정
      # MAXPEERS: 최대 피어 연결 수
      # ${MAXPEERS:-25}: 환경 변수가 없으면 '25'를 기본값으로 사용
      # 더 높은 값은 더 많은 피어를 허용하지만 대역폭과 리소스를 더 많이 소비합니다.
      MAXPEERS: ${MAXPEERS:-25}

    # ========================================================================
    # Network Configuration
    # ========================================================================
    # networks: 컨테이너가 연결될 Docker 네트워크를 지정합니다.
    # 여러 서비스가 같은 네트워크에 있으면 서비스 이름으로 서로 통신할 수 있습니다.
    networks:
      # ethereum-network: 아래 networks 섹션에서 정의된 네트워크
      # 이 네트워크에 연결된 다른 컨테이너들과 통신할 수 있습니다.
      - ethereum-network

    # ========================================================================
    # Resource Limits (Optional)
    # ========================================================================
    # deploy: Docker Swarm 모드에서 주로 사용되지만, docker-compose에서는 제한적으로 지원됩니다.
    # 주의: 'deploy' 섹션의 리소스 제한은 Docker Swarm 모드에서만 작동합니다.
    # docker-compose를 사용하는 경우 리소스 제한을 설정하려면 'docker update' 명령어를 사용해야 합니다.
    # 리소스 제한 (선택사항, Docker Swarm 모드에서만 작동)
    # deploy:
    #   resources:
    #     # limits: 컨테이너가 사용할 수 있는 최대 리소스
    #     # 이 값을 초과하면 컨테이너가 제한됩니다.
    #     limits:
    #       # cpus: 최대 CPU 코어 수
    #       # '8'은 8개의 CPU 코어를 의미합니다.
    #       # Geth와 Prysm 모두 CPU 집약적이므로 충분한 CPU를 할당하는 것이 좋습니다.
    #       cpus: '8'
    #       # memory: 최대 메모리 사용량
    #       # 16G는 16GB의 메모리를 의미합니다.
    #       # Geth cache 설정과 함께 고려하여 충분한 메모리를 할당해야 합니다.
    #       memory: 16G
    #     # reservations: 컨테이너에 보장할 최소 리소스
    #     # 시스템이 이만큼의 리소스를 항상 할당하려고 시도합니다.
    #     reservations:
    #       # cpus: 보장할 최소 CPU 코어 수
    #       # '4'는 최소 4개의 CPU 코어를 보장합니다.
    #       cpus: '4'
    #       # memory: 보장할 최소 메모리
    #       # 8G는 최소 8GB의 메모리를 보장합니다.
    #       memory: 8G

# ============================================================================
# Networks Definition
# ============================================================================
# networks: 컨테이너 간 통신을 위한 네트워크를 정의합니다.
# 같은 네트워크에 있는 컨테이너들은 서비스 이름으로 서로 통신할 수 있습니다.
networks:
  # ethereum-network: 네트워크 이름
  # 이 이름으로 위의 services 섹션에서 참조됩니다.
  ethereum-network:
    # driver: 네트워크 드라이버
    # bridge: 기본 브리지 네트워크 드라이버
    #   - 같은 호스트의 컨테이너들이 서로 통신할 수 있습니다.
    #   - 외부 네트워크와의 통신은 포트 매핑을 통해 이루어집니다.
    driver: bridge
