# version은 더 이상 필요하지 않습니다 (Docker Compose v2)

services:
  stellar:
    image: stellar/quickstart:latest
    container_name: stellar-node
    restart: unless-stopped
    # 네트워크 모드: local, testnet, futurenet, pubnet
    # local: 로컬 개발/테스트 네트워크 (빠른 원장 생성)
    # testnet: Stellar 테스트 네트워크
    # futurenet: 미래 프로토콜 변경 테스트 네트워크
    # pubnet: Stellar 메인넷 (프로덕션)
    # Quickstart 이미지는 --플래그 형식을 기대합니다
    command: --${NETWORK:-testnet}
    ports:
      # Horizon, RPC, Lab, Friendbot (메인 HTTP 포트)
      # ⚠️ Solana(8000-8025)와 충돌 방지를 위해 8100으로 변경
      - "0.0.0.0:8100:8000"
      # stellar-core P2P 네트워크 포트
      - "11625:11625"
      # stellar-core HTTP 관리 포트 (신뢰할 수 있는 네트워크에만 노출 권장)
      - "127.0.0.1:11626:11626"
      # PostgreSQL 포트 (로컬호스트만 노출, 보안 중요)
      # ⚠️ Ethereum PostgreSQL과 충돌 방지를 위해 5433으로 변경
      - "127.0.0.1:5433:5432"
      # Horizon 관리 포트 (선택사항)
      - "127.0.0.1:6060:6060"
      # RPC 관리 포트 (선택사항)
      - "127.0.0.1:6061:6061"
    volumes:
      # Persistent storage for Stellar data
      # IMPORTANT: Make sure /mnt/cryptocur-data/stellar directory exists and has proper permissions
      # Run: sudo mkdir -p /mnt/cryptocur-data/stellar
      # Run: sudo chown -R 10011001:10011001 /mnt/cryptocur-data/stellar
      # Note: Quickstart uses UID 10011001 for stellar user
      - /mnt/cryptocur-data/stellar:/opt/stellar
    environment:
      # 네트워크 선택: local, testnet, futurenet, pubnet
      NETWORK: ${NETWORK:-testnet}
      # PostgreSQL 비밀번호 (persistent mode에서 필수)
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-stellarpassword}
      # 활성화할 서비스 (기본값: core,horizon,rpc)
      # 옵션: core, horizon, rpc, lab, galexie
      ENABLE: ${ENABLE:-core,horizon,rpc}
      # 로그 활성화 (true/false)
      ENABLE_LOGS: ${ENABLE_LOGS:-false}
      # Core 로그 레벨 (FATAL, ERROR, WARNING, INFO, DEBUG, TRACE)
      CORE_LOG_LEVEL: ${CORE_LOG_LEVEL:-}
      # Core에서 PostgreSQL 사용 (기본값: SQLite)
      CORE_USE_POSTGRES: ${CORE_USE_POSTGRES:-}
      # 프로토콜 버전 (local 네트워크만)
      PROTOCOL_VERSION: ${PROTOCOL_VERSION:-}
      # 리소스 제한 (local 네트워크만: default, testnet, unlimited)
      # LIMITS: ${LIMITS:-testnet}
    networks:
      - stellar-network
    # Security options to fix permission denied issues in Snap Docker environment
    security_opt:
      - apparmor=unconfined

networks:
  stellar-network:
    driver: bridge
